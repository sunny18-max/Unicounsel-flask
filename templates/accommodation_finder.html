{% extends "dashboard_updated.html" %}

{% block title %}Accommodation Finder - UniCounsel{% endblock %}

{% block dashboard_content %}
<style>
    .accommodation-card { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden; }
    .accommodation-card:hover { transform: translateY(-6px); box-shadow: 0 16px 32px rgba(100, 200, 255, 0.15); }
    .accommodation-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #64c8ff, #7dd3fc); transform: scaleX(0); transform-origin: left; transition: transform 0.3s; }
    .accommodation-card:hover::before { transform: scaleX(1); }
    .type-icon { display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background: rgba(100, 200, 255, 0.1); border-radius: 8px; }
    .price-badge { display: inline-block; padding: 0.5rem 1rem; background: linear-gradient(135deg, #64c8ff, #7dd3fc); border-radius: 20px; color: #1a1f35; font-weight: bold; }
    .comparison-table { overflow-x: auto; }
    .comparison-row { display: grid; grid-template-columns: 200px repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding: 1rem; border-bottom: 1px solid rgba(100, 200, 255, 0.1); align-items: center; }
    .comparison-row:last-child { border-bottom: none; }
    .comparison-row:hover { background: rgba(100, 200, 255, 0.05); }
    .comparison-header { font-weight: bold; color: #64c8ff; }
    .amenity-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
    .amenity-item { display: flex; align-items: center; font-size: 0.875rem; }
    .amenity-item i { color: #34d399; margin-right: 0.5rem; }
    .uni-selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .uni-selector-card { padding: 1rem; background: rgba(100, 200, 255, 0.05); border: 2px solid rgba(100, 200, 255, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .uni-selector-card.selected { background: rgba(100, 200, 255, 0.15); border-color: #64c8ff; }
    .uni-selector-card:hover { border-color: #64c8ff; }
    .price-range { font-size: 0.75rem; margin-top: 0.5rem; color: #34d399; font-weight: 600; }
</style>

<div class="space-y-8">
    <div>
        <h1 class="text-4xl font-bold mb-2">
            <i class="fas fa-home mr-3 text-primary"></i>Accommodation Finder
        </h1>
        <p class="text-muted">Compare housing options and find the perfect accommodation near your university</p>
    </div>
    
    <!-- University Selector -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4">Select Universities to Compare</h2>
        <p class="text-sm text-muted mb-4">Choose 2-4 universities to compare accommodation options</p>
        <div id="universityGrid" class="uni-selector-grid"></div>
        <button id="compareBtn" class="mt-6 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-all" disabled>
            <i class="fas fa-chart-bar mr-2"></i>Compare Selected
        </button>
    </div>
    
    <!-- Accommodation Comparison Result -->
    <div id="comparisonResult" style="display: none;">
        <!-- Accommodation Types Overview -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-building mr-2"></i>Accommodation Types & Prices
            </h2>
            <div id="accommodationOverview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Detailed Comparison Table -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-layer-group mr-2"></i>Detailed Comparison
            </h2>
            <div class="comparison-table">
                <div class="comparison-row comparison-header">
                    <div>Feature</div>
                    <div id="comparisonHeaders"></div>
                </div>
                <div id="comparisonTableBody"></div>
            </div>
        </div>
        
        <!-- Amenities Comparison -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-star mr-2"></i>Popular Amenities
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <h3 class="font-bold mb-3 text-primary">On-Campus Housing</h3>
                    <div class="amenity-list">
                        <div class="amenity-item"><i class="fas fa-wifi"></i>WiFi Included</div>
                        <div class="amenity-item"><i class="fas fa-dumbbell"></i>Gym Access</div>
                        <div class="amenity-item"><i class="fas fa-book"></i>Study Rooms</div>
                        <div class="amenity-item"><i class="fas fa-utensils"></i>Meal Plans</div>
                        <div class="amenity-item"><i class="fas fa-bus"></i>Campus Transport</div>
                        <div class="amenity-item"><i class="fas fa-shield-alt"></i>Security 24/7</div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-3 text-primary">Shared Apartments</h3>
                    <div class="amenity-list">
                        <div class="amenity-item"><i class="fas fa-wifi"></i>WiFi Included</div>
                        <div class="amenity-item"><i class="fas fa-car"></i>Parking</div>
                        <div class="amenity-item"><i class="fas fa-tree"></i>Balcony/Patio</div>
                        <div class="amenity-item"><i class="fas fa-utensils"></i>Kitchen</div>
                        <div class="amenity-item"><i class="fas fa-bed"></i>Furnished</div>
                        <div class="amenity-item"><i class="fas fa-people-group"></i>Community Events</div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-3 text-primary">Private Housing</h3>
                    <div class="amenity-list">
                        <div class="amenity-item"><i class="fas fa-wifi"></i>WiFi Included</div>
                        <div class="amenity-item"><i class="fas fa-car"></i>Parking</div>
                        <div class="amenity-item"><i class="fas fa-bath"></i>Private Bathroom</div>
                        <div class="amenity-item"><i class="fas fa-kitchen"></i>Full Kitchen</div>
                        <div class="amenity-item"><i class="fas fa-wind"></i>AC/Heat</div>
                        <div class="amenity-item"><i class="fas fa-shield-alt"></i>Security Lock</div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-3 text-primary">Homestay</h3>
                    <div class="amenity-list">
                        <div class="amenity-item"><i class="fas fa-heart"></i>Family Support</div>
                        <div class="amenity-item"><i class="fas fa-utensils"></i>Meals Included</div>
                        <div class="amenity-item"><i class="fas fa-book"></i>Study Space</div>
                        <div class="amenity-item"><i class="fas fa-wifi"></i>WiFi Included</div>
                        <div class="amenity-item"><i class="fas fa-laundry"></i>Laundry Service</div>
                        <div class="amenity-item"><i class="fas fa-hands-helping"></i>Cultural Exchange</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-lightbulb mr-2"></i>Recommendations for You
            </h2>
            <div id="recommendationsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
</div>

<script>
    let selectedUniversities = new Set();
    let accommodationData = {};
    
    // Load universities
    async function loadUniversities() {
        try {
            const response = await fetch('/api/matches');
            const data = await response.json();
            const matches = data.matches || [];
            
            const grid = document.getElementById('universityGrid');
            grid.innerHTML = matches.slice(0, 12).map(uni => `
                <div class="uni-selector-card" data-id="${uni.university_id}">
                    <div class="font-bold text-sm">${uni.university_name}</div>
                    <div class="text-xs text-muted mt-1">${uni.city || 'N/A'}</div>
                    <div class="price-range">$${uni.annual_cost ? Math.round(uni.annual_cost/12) : 'N/A'}/mo</div>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.uni-selector-card').forEach(card => {
                card.addEventListener('click', function() {
                    const id = this.dataset.id;
                    if (selectedUniversities.has(id)) {
                        selectedUniversities.delete(id);
                        this.classList.remove('selected');
                    } else if (selectedUniversities.size < 4) {
                        selectedUniversities.add(id);
                        this.classList.add('selected');
                    }
                    document.getElementById('compareBtn').disabled = selectedUniversities.size < 2;
                });
            });
        } catch (error) {
            console.error('Error loading universities:', error);
        }
    }
    
    // Compare accommodations
    async function compareAccommodations() {
        if (selectedUniversities.size < 2) return;
        
        try {
            const ids = Array.from(selectedUniversities).join(',');
            const response = await fetch(`/api/accommodation-comparison?university_ids=${ids}`);
            const data = response.json();
            
            renderComparison(data);
            document.getElementById('comparisonResult').style.display = 'block';
            document.getElementById('comparisonResult').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error comparing accommodations:', error);
        }
    }
    
    // Render comparison results
    function renderComparison(data) {
        // Overview cards
        const overviewHtml = [
            { name: 'On-Campus', min: 800, max: 1500, icon: 'fas fa-building' },
            { name: 'Shared Apt', min: 600, max: 1000, icon: 'fas fa-users' },
            { name: 'Private', min: 1200, max: 2500, icon: 'fas fa-home' },
            { name: 'Homestay', min: 500, max: 900, icon: 'fas fa-heart' }
        ].map(type => `
            <div class="accommodation-card card glow-border">
                <div class="flex items-start justify-between mb-3">
                    <div class="type-icon">
                        <i class="${type.icon} text-xl text-primary"></i>
                    </div>
                    <span class="price-badge">$${type.min}-${type.max}</span>
                </div>
                <h3 class="text-lg font-bold mb-2">${type.name}</h3>
                <p class="text-sm text-muted">Per month</p>
            </div>
        `).join('');
        
        document.getElementById('accommodationOverview').innerHTML = overviewHtml;
        
        // Comparison headers
        const headerHtml = Array.from(selectedUniversities).map(id => {
            const match = data.universities?.find(u => u.university_id === id);
            return `<div>${match?.university_name.split(' ')[0] || 'Uni ' + id}</div>`;
        }).join('');
        document.getElementById('comparisonHeaders').innerHTML = headerHtml;
        
        // Comparison table rows
        const tableRows = [
            { name: 'On-Campus Min', key: 'on_campus_min' },
            { name: 'On-Campus Max', key: 'on_campus_max' },
            { name: 'Shared Apt Min', key: 'shared_min' },
            { name: 'Shared Apt Max', key: 'shared_max' },
            { name: 'Private Min', key: 'private_min' },
            { name: 'Private Max', key: 'private_max' },
            { name: 'Distance to Campus', key: 'distance' },
            { name: 'Avg Rating', key: 'rating' }
        ];
        
        const tableHtml = tableRows.map(row => {
            const cells = Array.from(selectedUniversities).map(id => {
                const uniData = data.universities?.find(u => u.university_id === id);
                const value = uniData?.accommodation?.[row.key] || 'N/A';
                return `<div>${value}</div>`;
            }).join('');
            return `<div class="comparison-row"><div class="font-semibold">${row.name}</div>${cells}</div>`;
        }).join('');
        
        document.getElementById('comparisonTableBody').innerHTML = tableHtml;
        
        // Recommendations
        const recs = [
            { title: 'Budget-Friendly Option', desc: 'Shared apartments offer the best value for money with excellent community vibes' },
            { title: 'Convenience & Support', desc: 'On-campus housing provides the closest proximity to campus facilities and 24/7 support' },
            { title: 'Independence & Privacy', desc: 'Private housing gives you full control and independence as you settle in your new city' },
            { title: 'Cultural Experience', desc: 'Homestay provides immersion in local culture and family-like support system' }
        ];
        
        document.getElementById('recommendationsList').innerHTML = recs.map(rec => `
            <div class="card glow-border">
                <h3 class="font-bold text-primary mb-2"><i class="fas fa-check-circle mr-2"></i>${rec.title}</h3>
                <p class="text-sm text-muted">${rec.desc}</p>
            </div>
        `).join('');
    }
    
    // Event listeners
    document.getElementById('compareBtn').addEventListener('click', compareAccommodations);
    
    // Initialize
    window.addEventListener('load', loadUniversities);
</script>
{% endblock %}
