{% extends "dashboard_updated.html" %}

{% block title %}Location Explorer - UniCounsel{% endblock %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
    #map { height: 500px; border-radius: 8px; margin-bottom: 1.5rem; }
    .leaflet-container { background: #1a1f35; }
    .place-card { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .place-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(100, 200, 255, 0.1); }
    .place-type-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .type-restaurant { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .type-jobs { background: rgba(74, 144, 226, 0.2); color: #4a90e2; }
    .type-accommodation { background: rgba(52, 211, 153, 0.2); color: #34d399; }
    .type-tourist { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
    .type-transport { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
    .filter-btn { padding: 0.5rem 1rem; border-radius: 6px; border: 2px solid transparent; transition: all 0.3s; }
    .filter-btn.active { border-color: #64c8ff; background: rgba(100, 200, 255, 0.1); color: #64c8ff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
    .stat-card { padding: 1.5rem; background: rgba(100, 200, 255, 0.05); border: 1px solid rgba(100, 200, 255, 0.2); border-radius: 8px; text-align: center; }
    .stat-number { font-size: 1.5rem; font-weight: bold; color: #64c8ff; }
    .stat-label { font-size: 0.875rem; color: #999; margin-top: 0.5rem; }
</style>

<div class="space-y-8">
    <div>
        <h1 class="text-4xl font-bold mb-2">
            <i class="fas fa-map-location-dot mr-3 text-primary"></i>Location Explorer
        </h1>
        <p class="text-muted">Discover universities and explore nearby amenities in your preferred cities</p>
    </div>
    
    <!-- University & Filter Selection -->
    <div class="card">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Select University</label>
                <select id="universitySelect" class="w-full px-4 py-2 border border-border rounded-lg text-white focus:outline-none focus:border-primary" style="background-color: #1a1f35;">
                    <option value="">-- Choose a University --</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Filter Places By Type</label>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="restaurant">Food</button>
                    <button class="filter-btn" data-filter="jobs">Jobs</button>
                    <button class="filter-btn" data-filter="accommodation">Housing</button>
                    <button class="filter-btn" data-filter="tourist">Tourist</button>
                    <button class="filter-btn" data-filter="transport">Transport</button>
                </div>
            </div>
        </div>
        
        <!-- Location Statistics -->
        <div id="statsContainer" class="stats-grid mb-6"></div>
        
        <!-- Interactive Map -->
        <div id="map"></div>
    </div>
    
    <!-- Nearby Places Grid -->
    <div class="card">
        <h2 class="text-2xl font-bold mb-6">
            <i class="fas fa-compass mr-2"></i>Nearby Amenities & Services
        </h2>
        
        <div id="placesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="text-center py-12 text-muted">
                <i class="fas fa-info-circle text-2xl mb-3"></i>
                <p>Select a university to view nearby places</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    let map = null;
    let universities = [];
    let currentFilter = 'all';
    let currentUniversity = null;
    
    // Initialize map
    function initMap() {
        if (map === null) {
            map = L.map('map').setView([-25.2744, 133.7751], 4); // Australia center
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
        }
    }
    
    // Fetch universities for selector
    async function loadUniversities() {
        try {
            const response = await fetch('/api/matches');
            const data = await response.json();
            universities = data.matches || [];
            
            const select = document.getElementById('universitySelect');
            universities.forEach(uni => {
                const option = document.createElement('option');
                option.value = uni.university_id;
                option.textContent = `${uni.university_name} (${uni.city || 'N/A'})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading universities:', error);
        }
    }
    
    // Load nearby places for selected university
    async function loadNearbyPlaces(universityId) {
        if (!universityId) {
            document.getElementById('placesContainer').innerHTML = 
                '<div class="col-span-full text-center py-12 text-muted"><i class="fas fa-info-circle text-2xl mb-3"></i><p>Select a university to view nearby places</p></div>';
            document.getElementById('statsContainer').innerHTML = '';
            if (map) map.setView([-25.2744, 133.7751], 4);
            return;
        }
        
        try {
            const response = await fetch(`/api/nearby-places?university_id=${universityId}&type=${currentFilter}`);
            const data = await response.json();
            currentUniversity = data.university;
            
            // Update map
            initMap();
            map.setView([data.university.latitude || -25.2744, data.university.longitude || 133.7751], 13);
            L.circleMarker([data.university.latitude || -25.2744, data.university.longitude || 133.7751], {
                radius: 8,
                fillColor: '#64c8ff',
                color: '#64c8ff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8,
                popup: data.university.university_name
            }).addTo(map).openPopup();
            
            // Update statistics
            updateStats(data.places);
            
            // Render places
            renderPlaces(data.places);
        } catch (error) {
            console.error('Error loading places:', error);
            document.getElementById('placesContainer').innerHTML = '<div class="text-red-500">Error loading places</div>';
        }
    }
    
    // Update statistics
    function updateStats(places) {
        const stats = {
            restaurants: 0,
            jobs: 0,
            accommodation: 0,
            tourist: 0,
            transport: 0
        };
        
        places.forEach(p => {
            const type = p.type.toLowerCase();
            if (type === 'restaurant') stats.restaurants++;
            else if (type === 'jobs') stats.jobs++;
            else if (type === 'accommodation') stats.accommodation++;
            else if (type === 'tourist') stats.tourist++;
            else if (type === 'transport') stats.transport++;
        });
        
        const statsHtml = `
            <div class="stat-card">
                <div class="stat-number">${stats.restaurants}</div>
                <div class="stat-label">Restaurants</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.jobs}</div>
                <div class="stat-label">Part-Time Jobs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.accommodation}</div>
                <div class="stat-label">Housing Options</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.tourist}</div>
                <div class="stat-label">Tourist Sites</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.transport}</div>
                <div class="stat-label">Transport Hubs</div>
            </div>
        `;
        document.getElementById('statsContainer').innerHTML = statsHtml;
    }
    
    // Render places in grid
    function renderPlaces(places) {
        const container = document.getElementById('placesContainer');
        if (places.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-8 text-muted">No places found for this filter</div>';
            return;
        }
        
        const typeIcons = {
            'restaurant': 'fas fa-utensils',
            'jobs': 'fas fa-briefcase',
            'accommodation': 'fas fa-building',
            'tourist': 'fas fa-camera',
            'transport': 'fas fa-bus'
        };
        
        const typeBadgeClass = {
            'restaurant': 'type-restaurant',
            'jobs': 'type-jobs',
            'accommodation': 'type-accommodation',
            'tourist': 'type-tourist',
            'transport': 'type-transport'
        };
        
        container.innerHTML = places.map(place => `
            <div class="place-card card glow-border">
                <div class="flex items-start justify-between mb-3">
                    <i class="${typeIcons[place.type.toLowerCase()]} text-2xl text-primary"></i>
                    <span class="place-type-badge ${typeBadgeClass[place.type.toLowerCase()]}">${place.type}</span>
                </div>
                <h3 class="text-lg font-bold mb-2">${place.name}</h3>
                <p class="text-sm text-muted mb-3">${place.description}</p>
                <div class="space-y-2">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-map-pin text-primary mr-2 w-4"></i>
                        <span>${place.distance}km away</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-star text-yellow-400 mr-2 w-4"></i>
                        <span>${place.rating}/5 (${place.reviews} reviews)</span>
                    </div>
                    ${place.price ? `<div class="flex items-center text-sm">
                        <i class="fas fa-dollar-sign text-green-400 mr-2 w-4"></i>
                        <span>$${place.price}/month</span>
                    </div>` : ''}
                    ${place.salary_range ? `<div class="flex items-center text-sm">
                        <i class="fas fa-coins text-amber-400 mr-2 w-4"></i>
                        <span>${place.salary_range}/hour</span>
                    </div>` : ''}
                </div>
            </div>
        `).join('');
    }
    
    // Event listeners
    document.getElementById('universitySelect').addEventListener('change', (e) => {
        currentFilter = 'all';
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-filter="all"]').classList.add('active');
        loadNearbyPlaces(e.target.value);
    });
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            if (document.getElementById('universitySelect').value) {
                loadNearbyPlaces(document.getElementById('universitySelect').value);
            }
        });
    });
    
    // Initialize on load
    window.addEventListener('load', loadUniversities);
</script>
{% endblock %}
