{% extends "dashboard_updated.html" %}

{% block title %}Cost Calculator - UniCounsel{% endblock %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.css" />
<style>
    .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
    .cost-item { padding: 1.5rem; background: rgba(100, 200, 255, 0.05); border-left: 4px solid #64c8ff; border-radius: 6px; }
    .cost-item.accent1 { border-left-color: #34d399; }
    .cost-item.accent2 { border-left-color: #fb923c; }
    .cost-item.accent3 { border-left-color: #f472b6; }
    .cost-item.accent4 { border-left-color: #a855f7; }
    .cost-label { font-size: 0.875rem; color: #999; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .cost-amount { font-size: 1.75rem; font-weight: bold; color: #64c8ff; }
    .timeline-item { padding: 2rem; border-left: 3px solid #64c8ff; margin-left: 1rem; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -8px; top: 2rem; width: 12px; height: 12px; background: #64c8ff; border-radius: 50%; }
    .timeline-item:last-child { border-left-color: #34d399; }
    .timeline-item:last-child::before { background: #34d399; }
    .category-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
    .category-card { padding: 1.5rem; background: linear-gradient(135deg, rgba(100, 200, 255, 0.1), rgba(52, 211, 153, 0.05)); border: 1px solid rgba(100, 200, 255, 0.2); border-radius: 8px; }
    .chart-container { position: relative; height: 300px; margin: 2rem 0; }
    .savings-tip { padding: 1.5rem; background: linear-gradient(135deg, #34d399, #10b981); border-radius: 8px; color: #1a1f35; }
    .savings-tip strong { font-size: 1.1rem; display: block; margin-bottom: 0.5rem; }
</style>

<div class="space-y-8">
    <div>
        <h1 class="text-4xl font-bold mb-2">
            <i class="fas fa-calculator mr-3 text-primary"></i>Cost Calculator
        </h1>
        <p class="text-muted">Estimate your total study abroad expenses with detailed breakdowns</p>
    </div>
    
    <!-- Input Configuration -->
    <div class="card">
        <h2 class="text-2xl font-bold mb-6">Configure Your Study Plan</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Country</label>
                <select id="country" class="w-full border border-border rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary" style="background-color: #1a1f35;">
                    <option value="">-- Select Country --</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Study Duration (years)</label>
                <input type="number" id="duration" min="1" max="8" value="1" class="w-full border border-border rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary" style="background-color: #1a1f35;">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Accommodation Type</label>
                <select id="accommodation" class="w-full border border-border rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary" style="background-color: #1a1f35;">
                    <option value="shared">Shared Apartment</option>
                    <option value="private">Private Housing</option>
                    <option value="campus">On-Campus Housing</option>
                    <option value="home">Homestay</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card glow-border">
            <div class="text-sm text-muted mb-2">Weekly Cost</div>
            <div class="text-3xl font-bold text-primary">$<span id="weekly-cost">0</span></div>
        </div>
        <div class="card glow-border">
            <div class="text-sm text-muted mb-2">Monthly Cost</div>
            <div class="text-3xl font-bold text-primary">$<span id="monthly-cost">0</span></div>
        </div>
        <div class="card glow-border">
            <div class="text-sm text-muted mb-2">Annual Cost</div>
            <div class="text-3xl font-bold text-primary">$<span id="annual-cost">0</span></div>
        </div>
        <div class="card glow-border">
            <div class="text-sm text-muted mb-2">Total Study Period</div>
            <div class="text-3xl font-bold text-green-400">$<span id="total-cost">0</span></div>
        </div>
    </div>
    
    <!-- Cost Breakdown by Category -->
    <div class="card">
        <h2 class="text-2xl font-bold mb-6">
            <i class="fas fa-pie-chart mr-2"></i>Annual Cost Breakdown
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
            <div class="cost-breakdown">
                <div class="cost-item">
                    <div class="cost-label">Tuition</div>
                    <div class="cost-amount">$<span id="tuition-cost">0</span></div>
                </div>
                <div class="cost-item accent1">
                    <div class="cost-label">Accommodation</div>
                    <div class="cost-amount">$<span id="accommodation-cost">0</span></div>
                </div>
                <div class="cost-item accent2">
                    <div class="cost-label">Food & Dining</div>
                    <div class="cost-amount">$<span id="food-cost">0</span></div>
                </div>
                <div class="cost-item accent3">
                    <div class="cost-label">Transport</div>
                    <div class="cost-amount">$<span id="transport-cost">0</span></div>
                </div>
                <div class="cost-item accent4">
                    <div class="cost-label">Personal & Misc</div>
                    <div class="cost-amount">$<span id="personal-cost">0</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Timeline Breakdown -->
    <div class="card">
        <h2 class="text-2xl font-bold mb-6">
            <i class="fas fa-timeline mr-2"></i>Cost Timeline
        </h2>
        <div id="timelineContainer"></div>
    </div>
    
    <!-- Category Details -->
    <div class="card">
        <h2 class="text-2xl font-bold mb-6">
            <i class="fas fa-list mr-2"></i>Detailed Expense Categories
        </h2>
        <div class="category-breakdown">
            <div class="category-card">
                <h3 class="font-bold text-primary mb-3"><i class="fas fa-graduation-cap mr-2"></i>Tuition & Fees</h3>
                <ul class="text-sm space-y-2">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Annual Tuition: $<span id="det-tuition">0</span></li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Registration Fees: Included</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Library & Lab: Included</li>
                </ul>
            </div>
            
            <div class="category-card">
                <h3 class="font-bold text-primary mb-3"><i class="fas fa-bed mr-2"></i>Accommodation</h3>
                <ul class="text-sm space-y-2">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Monthly: $<span id="det-accommodation">0</span></li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Utilities: Included</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Internet: Included</li>
                </ul>
            </div>
            
            <div class="category-card">
                <h3 class="font-bold text-primary mb-3"><i class="fas fa-utensils mr-2"></i>Food & Dining</h3>
                <ul class="text-sm space-y-2">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Weekly Budget: $<span id="det-food">0</span></li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Self-Catering Avg</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Eating Out 2-3x/week</li>
                </ul>
            </div>
            
            <div class="category-card">
                <h3 class="font-bold text-primary mb-3"><i class="fas fa-bus mr-2"></i>Transportation</h3>
                <ul class="text-sm space-y-2">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Public Transport Pass: $<span id="det-transport">0</span></li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Monthly Student Discount</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Occasional Flights Home</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Savings Tips -->
    <div class="savings-tip">
        <strong><i class="fas fa-lightbulb mr-2"></i>Money-Saving Tips</strong>
        <ul class="text-sm space-y-2 mt-3 list-none">
            <li>✓ Look for university scholarships covering 25-50% of tuition</li>
            <li>✓ Shared apartments can save you 30-40% compared to private housing</li>
            <li>✓ Cook at home 4-5 days per week to reduce food costs by 50%</li>
            <li>✓ Use student discounts on public transport (20-30% savings)</li>
            <li>✓ Work part-time (10-15 hrs/week) to offset living expenses</li>
            <li>✓ Apply for work-study programs on campus (reduced tuition)</li>
        </ul>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
<script>
    let costData = {
        tuition: 20000,
        accommodation: { shared: 600, private: 1500, campus: 900, home: 400 },
        food: 3000,
        transport: 1000,
        personal: 2000
    };
    
    let chart = null;
    
    async function loadCountries() {
        try {
            const res = await fetch('/api/filters');
            const data = await res.json();
            const select = document.getElementById('country');
            (data.countries || []).forEach(country => {
                const opt = document.createElement('option');
                opt.value = country;
                opt.textContent = country;
                select.appendChild(opt);
            });
            costData.avgCosts = data.avg_cost_by_country || {};
        } catch (err) {
            console.error('Failed to load countries:', err);
        }
    }
    
    function calculateCosts() {
        const country = document.getElementById('country').value;
        const duration = parseInt(document.getElementById('duration').value) || 1;
        const accommodationType = document.getElementById('accommodation').value;
        
        if (!country) {
            document.getElementById('weekly-cost').textContent = '0';
            document.getElementById('monthly-cost').textContent = '0';
            document.getElementById('annual-cost').textContent = '0';
            document.getElementById('total-cost').textContent = '0';
            return;
        }
        
        const annualTuition = costData.avgCosts?.[country] || costData.tuition;
        const monthlyAccommodation = costData.accommodation[accommodationType] || 900;
        const annualAccommodation = monthlyAccommodation * 12;
        const annualFood = costData.food;
        const annualTransport = costData.transport;
        const annualPersonal = costData.personal;
        
        const annualTotal = annualTuition + annualAccommodation + annualFood + annualTransport + annualPersonal;
        const monthlyTotal = Math.round(annualTotal / 12);
        const weeklyTotal = Math.round(annualTotal / 52);
        const totalForDuration = annualTotal * duration;
        
        // Update display
        document.getElementById('weekly-cost').textContent = weeklyTotal.toLocaleString();
        document.getElementById('monthly-cost').textContent = monthlyTotal.toLocaleString();
        document.getElementById('annual-cost').textContent = Math.round(annualTotal).toLocaleString();
        document.getElementById('total-cost').textContent = Math.round(totalForDuration).toLocaleString();
        
        // Update breakdown
        document.getElementById('tuition-cost').textContent = Math.round(annualTuition).toLocaleString();
        document.getElementById('accommodation-cost').textContent = Math.round(annualAccommodation).toLocaleString();
        document.getElementById('food-cost').textContent = annualFood.toLocaleString();
        document.getElementById('transport-cost').textContent = annualTransport.toLocaleString();
        document.getElementById('personal-cost').textContent = annualPersonal.toLocaleString();
        
        // Detailed costs
        document.getElementById('det-tuition').textContent = Math.round(annualTuition).toLocaleString();
        document.getElementById('det-accommodation').textContent = monthlyAccommodation.toLocaleString();
        document.getElementById('det-food').textContent = Math.round(annualFood / 52).toLocaleString();
        document.getElementById('det-transport').textContent = Math.round(annualTransport / 12).toLocaleString();
        
        // Update chart
        updateChart(annualTuition, annualAccommodation, annualFood, annualTransport, annualPersonal);
        
        // Update timeline
        updateTimeline(duration, monthlyTotal, weeklyTotal);
    }
    
    function updateChart(tuition, accommodation, food, transport, personal) {
        const ctx = document.getElementById('costChart').getContext('2d');
        
        if (chart) chart.destroy();
        
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Tuition', 'Accommodation', 'Food', 'Transport', 'Personal'],
                datasets: [{
                    data: [tuition, accommodation, food, transport, personal],
                    backgroundColor: ['#64c8ff', '#34d399', '#fb923c', '#f472b6', '#a855f7'],
                    borderColor: '#1a1f35',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#fff', padding: 20 } }
                }
            }
        });
    }
    
    function updateTimeline(duration, monthlyTotal, weeklyTotal) {
        const timeline = document.getElementById('timelineContainer');
        let html = '';
        
        for (let year = 1; year <= duration; year++) {
            html += `
                <div class="timeline-item">
                    <h3 class="font-bold mb-2">Year ${year}</h3>
                    <p class="text-sm text-muted mb-3">Annual cost: $${(monthlyTotal * 12).toLocaleString()}</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div><span class="text-xs text-muted">Weekly</span><br><span class="font-bold">$${weeklyTotal.toLocaleString()}</span></div>
                        <div><span class="text-xs text-muted">Monthly</span><br><span class="font-bold">$${monthlyTotal.toLocaleString()}</span></div>
                        <div><span class="text-xs text-muted">Cumulative</span><br><span class="font-bold text-primary">$${(monthlyTotal * 12 * year).toLocaleString()}</span></div>
                    </div>
                </div>
            `;
        }
        timeline.innerHTML = html;
    }
    
    document.getElementById('country').addEventListener('change', calculateCosts);
    document.getElementById('duration').addEventListener('input', calculateCosts);
    document.getElementById('accommodation').addEventListener('change', calculateCosts);
    
    window.addEventListener('load', loadCountries);
</script>
{% endblock %}